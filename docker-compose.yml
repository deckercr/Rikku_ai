services:
  # --- THE LLM ENGINE (Ollama) ---
  llm:
    image: ollama/ollama:latest
    container_name: ai_llm
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # --- THE DATABASE (Postgres + pgvector) ---
  db:
    image: pgvector/pgvector:pg16
    container_name: ai_db
    env_file:
      - .env
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  # --- THE BRAIN (Django) ---
  django:
    build:
      context: ./django_app
      dockerfile: Dockerfile
    container_name: ai_django
    volumes:
      - ./django_app:/app
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_HOST=db
      - OLLAMA_URL=http://llm:11434
    ports:
      - "8080:8080"
    command: python manage.py runserver 0.0.0.0:8080
    depends_on:
      - llm
      - db
    # Uncomment when webcam is available:
    # devices:
    #   - /dev/video0:/dev/video0

volumes:
  postgres_data:
  ollama_data:
